/*! Sifrr.Seo v0.0.4 - sifrr project | MIT licensed | https://github.com/sifrr/sifrr */
import e from"puppeteer";import t from"cache-manager";const s=["document","script","xhr","fetch"];var n=class{constructor(e,t=(()=>!0)){this.npage=e,this.filter=t,this.pendingRequests=0,this.pendingPromise=new Promise(e=>this.pendingResolver=e),this.addOnRequestListener(),this.addEndRequestListener()}addOnRequestListener(){const e=this;this.addListener=this.npage.setRequestInterception(!0).then(()=>{e.npage.on("request",t=>{(function(e,t){const s=e.resourceType();return-1!==t.indexOf(s)})(t,s)&&this.filter(t.url())?(e.pendingRequests++,t.__allowed=!0,t.continue()):(t.__allowed=!1,t.abort())})})}addEndRequestListener(){const e=this;this.npage.on("requestfailed",t=>{e.onEnd(t)}),this.npage.on("requestfinished",t=>{e.onEnd(t)})}onEnd(e){e.__allowed&&(this.pendingRequests--,0===this.pendingRequests&&this.pendingResolver())}all(){return 0===this.pendingRequests?Promise.resolve(!0):this.pendingPromise}};var r=class{constructor(e={},t={}){this.status=0,this.puppeteerOptions=Object.assign({headless:!0,args:[]},e),this.puppeteerOptions.args.push("--no-sandbox","--disable-setuid-sandbox"),this.options=t}async browserAsync(){const t=this;return 0===this.status&&(this.status=1,this._browser=e.launch(this.puppeteerOptions).then(e=>(this.status=2,t.browser=e,e.on("disconnected",()=>{t.status=0}),e))),this._browser}close(){return 2===this.status?this.browser.close():1===this.status?this._browser.then(e=>e.close()):Promise.resolve(!0)}render(e){const t=e.fullUrl,s=this;return this.browserAsync().then(()=>this.browser.newPage()).then(async r=>{const i=new n(r,s.options.filterOutgoingRequests);await i.addListener;const o=e.headers||{};delete o["user-agent"],await r.setExtraHTTPHeaders(o),s.options.beforeRender&&await r.evaluateOnNewDocument(s.options.beforeRender);const h=await r.goto(t,{waitUntil:"load"});let a;return s.isHTML(h)?(await i.all(),s.options.afterRender&&await r.evaluate(s.options.afterRender),a=await r.content()):a=!1,await r.close(),a})}isHTML(e){return e.headers()["content-type"]&&e.headers()["content-type"].indexOf("html")>=0}},i=e=>(e=Object.assign({cacheStore:"memory",maxCacheSize:100,ttl:0},e),t.caching({store:e.cacheStore,ttl:e.ttl,length:(e,t)=>Buffer.from(t+t+e).length+2,max:1e6*e.maxCacheSize}));const{headerName:o,headerValue:h}={noop:()=>{},headerName:"X-SSR-Powered-By",headerValue:"@sifrr/seo"};var a=function(e,t,s){if("GET"!==e.method)return s();const n={fullUrl:this.renderer.options.fullUrl(e),headers:e.headers};return null===this.getShouldRenderCache(n)&&(t._end=t.end,t.end=((e,s)=>{if(t.hasHeader("content-type")){t.getHeader("content-type").indexOf("html")>=0?this.setShouldRenderCache(n,!0):this.setShouldRenderCache(n,!1)}t._end(e,s)})),this.render(n).then(e=>{e?(t.set(o,h),t.send(e)):s()}).catch(e=>{"No Render"===e.message?s():s(e)})};const d=new RegExp("(headless|Headless)");class c{constructor(e=["Googlebot","Bingbot","Slurp","DuckDuckBot","Baiduspider","YandexBot","Sogou","Exabot"],t={}){this._uas=e.map(e=>new RegExp(e)),this.shouldRenderCache={},this.options=Object.assign({cacheKey:e=>e.fullUrl,fullUrl:e=>`http://127.0.0.1:80${e.originalUrl}`},t)}get middleware(){return a.bind(this)}isHeadless(e){const t=e.headers["user-agent"];return!!d.test(t)}shouldRender(e){return this.isUserAgent(e)}isUserAgent(e){const t=e.headers["user-agent"];let s=!1;return this._uas.forEach(e=>{e.test(t)&&(s=!0)}),s}addUserAgent(e){this._uas.push(new RegExp(e))}clearCache(){this.cache.reset()}close(){return this.renderer.close()}setPuppeteerOption(e,t){this._poptions=this._poptions||{},this._poptions[e]=t}get cache(){return this._cache=this._cache||i(this.options),this._cache}setShouldRenderCache(e,t){const s=this.options.cacheKey(e);this.shouldRenderCache[s]=t}getShouldRenderCache(e){const t=this.options.cacheKey(e);return void 0===this.shouldRenderCache[t]?null:this.shouldRenderCache[t]}async render(e){if(!1===this.getShouldRenderCache(e))throw Error("No Render");if(this.shouldRender(e)&&!this.isHeadless(e)){const t=this.options.cacheKey(e);return new Promise((s,n)=>{this.cache.get(t,(r,i)=>{r?n(r):i?s(i):this.renderer.render(e).then(e=>{this.cache.set(t,e),s(e)}).catch(e=>{n(e)})})})}throw Error("No Render")}get renderer(){return this._renderer=this._renderer||new c.Renderer(this._poptions,this.options),this._renderer}}c.Renderer=r;export default c;
/*! (c) @aadityataparia */
