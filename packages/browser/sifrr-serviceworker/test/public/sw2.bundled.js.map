{"version":3,"file":"sw2.bundled.js","sources":["../../src/sifrr.serviceworker.js","sw2.js"],"sourcesContent":["class SW {\n  constructor(options) {\n    this.options = Object.assign({\n      version: 1,\n      fallbackCacheName: 'fallbacks',\n      defaultCacheName: 'default',\n      policies: {},\n      fallbacks: {},\n      precacheUrls: []\n    }, options);\n    this.options.policies.default = Object.assign(this.options.policies.default || {}, {\n      policy: 'NETWORK_FIRST',\n      cacheName: this.options.defaultCacheName\n    });\n  }\n\n  setup() {\n    self.addEventListener('install', this.installEventListener.bind(this));\n    self.addEventListener('activate', this.activateEventListener.bind(this));\n    self.addEventListener('fetch', this.fetchEventListener.bind(this));\n  }\n\n  setupPushNotification(defaultTitle = '', defaultOptions = { body: '' }) {\n    this.defaultPushTitle = defaultTitle;\n    this.defaultPushOptions = defaultOptions;\n    self.addEventListener('push', this.pushEventListener.bind(this));\n    self.addEventListener('notificationclick', this.onNotificationClick.bind(this));\n  }\n\n  installEventListener(event) {\n    event.waitUntil(this.precache());\n    this.onInstall(event);\n  }\n\n  /* istanbul ignore next */\n  onInstall() {}\n\n  activateEventListener() {\n    const version = '-v' + this.options.version;\n    // remove old version caches\n    caches.keys().then(cacheNames => {\n      return cacheNames.filter(cacheName => cacheName.indexOf(version) < 0);\n    }).then(cachesToDelete => {\n      return Promise.all(cachesToDelete.map(cacheToDelete => {\n        return caches.delete(cacheToDelete);\n      }));\n    }).then(() => self.clients.claim());\n  }\n\n  fetchEventListener(event) {\n    const request = event.request;\n    const otherReq = request.clone();\n    const oreq = request.clone();\n    if (request.method === 'GET') {\n      event.respondWith(this.respondWithPolicy(request).then(response => {\n        if (!response.ok && response.status > 0 && this.findRegex(oreq.url, this.options.fallbacks)) {\n          throw Error('response status ' + response.status);\n        }\n        return response;\n      }).catch((e) => this.respondWithFallback(otherReq, e)));\n    }\n  }\n\n  pushEventListener(event) {\n    let data = {};\n    if (event.data) {\n      if (typeof event.data.json === 'function') data = event.data.json();\n      else data = event.data.json;\n    }\n\n    const title = data.title || this.defaultPushTitle;\n    const options = Object.assign(this.defaultPushOptions, data);\n\n    return self.registration.showNotification(title, options);\n  }\n\n  /* istanbul ignore next */\n  onNotificationClick() {}\n\n  precache(urls = this.options.precacheUrls, fbs = this.options.fallbacks) {\n    const me = this;\n    let promises = [];\n    urls.forEach(u => {\n      let req = me.requestFromURL(u);\n      return promises.push(me.responseFromNetwork(req, me.findRegex(u, me.options.policies).cacheName));\n    });\n    for (let value of Object.values(fbs)) {\n      let req = this.requestFromURL(value);\n      promises.push(this.responseFromNetwork(req, this.options.fallbackCacheName));\n    }\n    return Promise.all(promises);\n  }\n\n  respondWithFallback(request, error) {\n    const fallback = this.requestFromURL(this.findRegex(request.url, this.options.fallbacks));\n    if (fallback !== undefined) {\n      return this.responseFromCache(fallback, this.options.fallbackCacheName);\n    } else {\n      /* istanbul ignore next */\n      throw error;\n    }\n  }\n\n  respondWithPolicy(request) {\n    const req1 = request.clone();\n    const req2 = request.clone();\n    const config = this.findRegex(request.url, this.options.policies);\n    const policy = config.policy;\n    const cacheName = config.cacheName || this.options.defaultCacheName;\n\n    let resp;\n    switch (policy) {\n    case 'NETWORK_ONLY':\n      resp = this.responseFromNetwork(req1, cacheName, false);\n      break;\n    case 'CACHE_FIRST':\n    case 'CACHE_ONLY':\n      resp = this.responseFromCache(req1, cacheName)\n        .catch(() => this.responseFromNetwork(request, cacheName));\n      break;\n    case 'CACHE_AND_UPDATE':\n      resp = this.responseFromCache(req1, cacheName)\n        .catch(() => this.responseFromNetwork(request, cacheName));\n      this.responseFromNetwork(req2, cacheName);\n      break;\n    default:\n      resp = this.responseFromNetwork(req1, cacheName)\n        .catch(() => this.responseFromCache(request, cacheName));\n      break;\n    }\n    return resp;\n  }\n\n  responseFromNetwork(request, cache, putInCache = true) {\n    return caches.open(cache + '-v' + this.options.version).then(cache => fetch(request).then(response => {\n      if (putInCache) cache.put(request, response.clone());\n      return response;\n    }));\n  }\n\n  responseFromCache(request, cache) {\n    return caches.open(cache + '-v' + this.options.version).then(cache => cache.match(request)).then(resp => {\n      if (resp) return resp;\n      else throw 'Cache not found for ' + request.url;\n    });\n  }\n\n  requestFromURL(url, method = 'GET') {\n    return new Request(url, {\n      method: method\n    });\n  }\n\n  findRegex(url, policies) {\n    for (let [key, value] of Object.entries(policies)) {\n      const regex = new RegExp(key);\n      if (regex.test(url)) return value;\n    }\n    return policies['default'];\n  }\n}\n\nmodule.exports = SW;\n","const SW = require('../../src/sifrr.serviceworker');\n\nconst sw = new SW({\n  version: 2,\n  fallbackCacheName: 'ffff',\n  fallbacks: {\n    networkonly: '/offline.html'\n  }\n});\n\nsw.setup();\nsw.onInstall = () => {\n  self.skipWaiting();\n};\nsw.setupPushNotification();\nself.addEventListener('message', async (e) => {\n  if (e.data === 'coverage') {\n    e.ports[0].postMessage(self.__coverage__);\n  } else if (e.data === 'caches') {\n    e.ports[0].postMessage(await caches.keys());\n  } else if (e.data.type && e.data.type === 'push') {\n    sw.pushEventListener(e.data.event);\n  }\n});\nmodule.exports = sw;\n"],"names":["SW","constructor","options","Object","assign","version","fallbackCacheName","defaultCacheName","policies","fallbacks","precacheUrls","default","policy","cacheName","setup","self","addEventListener","installEventListener","bind","activateEventListener","fetchEventListener","setupPushNotification","defaultTitle","defaultOptions","body","defaultPushTitle","defaultPushOptions","pushEventListener","onNotificationClick","event","waitUntil","precache","onInstall","caches","keys","then","cacheNames","filter","indexOf","cachesToDelete","Promise","all","map","cacheToDelete","delete","clients","claim","request","otherReq","clone","oreq","method","respondWith","respondWithPolicy","response","ok","status","findRegex","url","Error","catch","e","respondWithFallback","data","json","title","registration","showNotification","urls","fbs","me","promises","forEach","u","req","requestFromURL","push","responseFromNetwork","value","values","error","fallback","undefined","responseFromCache","req1","req2","config","resp","cache","putInCache","open","fetch","put","match","Request","key","entries","regex","RegExp","test","sw","networkonly","skipWaiting","ports","postMessage","__coverage__","type"],"mappings":"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"}